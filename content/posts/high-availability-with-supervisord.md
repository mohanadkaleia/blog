Title: High Availability with Supervisord
Date: 2020-12-29
Author: Mohanad Kaleia
Category: Software Engineering
Tags: supervisord, availability
Slug: high-availability-with-supervisord
Direction: rtl
Cover: ../../static/images/high-availability-with-supervisord/supervisord.png

![](../../static/images/high-availability-with-supervisord/supervisord.png)

ูู ุนุงูู ููุฏุณุฉ ุงูุจุฑูุฌูุงุชุ ููุฌุฏ ูุนูุงุฑ ูุงู ุฌุฏุงู ูุชุญุฏูุฏ ูููุง ุฅุฐุง ูุงูุช ุงูุจุฑูุฌูุฉ ุฃู ุงูุฎุฏูุฉ (ุณููุง ูุง ุดุฆุช) ููุซููุฉ ุฃู ูุงุ ูุฐุง ุงููุนูุงุฑ ูู ุงูุฌุงูุฒูุฉ availabilityุ ุจุญูุซ ุฃู ุงููุธุงู ุฃู ุงูุฎุฏูุฉ ูุฌุจ ุฃู ุชููู ูุชููุฑุฉ ูุฌุงูุฒุฉ ููุงุณุชุนูุงู ูู ุฃู ููุช ูุงู. ูุซูุงู ูู ุญุงู ูุงู ูุฏูู ุฎุฏูุฉ ุจุฑูุฏ ุงููุชุฑูููุ ูุฐู ุงูุฎุฏูุฉ ูุฌุจ ุฃู ุชููู ูุชููุฑุฉ ุจุดูู ุฏุงุฆู ุจุญูุซ ุฃู ุฒุจูู ุญุงูู ุงูุงุชุตุงู ุจูุฐู ุงูุฎุฏูุฉ ูุฌุจ ุฃู ูุณุชุทูุน ุงููุตูู ูุงุณุชุนูุงู ูุฐู ุงูุฎุฏูุฉ. 

ูู ุชุฏูููุชูุง ุงููููุ ุณูู ูุชููู ุนู ููู ูููู ุฃุฏุงุฑุฉ ุจุฑูุงูุฌ ุจุณูุท ุจุญูุซ ูุญูู ุฌุงูุฒูุฉ ุนุงููุฉ ุญุชู ูู ุญุงู ุญุฏูุซ ุฃุฎุทุงุกุ ุจุดูู ุฎุงุต ุณูู ูุชููู ุนู ุฃุฏุงุฉ ูุฃุฏุงุฑุฉ ููุฑุงูุจุฉ ุงููุนุงูุฌุงุช Supervisord. 


![](https://media.giphy.com/media/3oKHW8JB6ItMjIqXcs/giphy.gif)


--- 

# Availability ุงูุฌููุฒูุฉ

ูุง ุจุฃุณ ูู ุงูุจุฏุงูุฉ ูู ุชูุถูุญ ููููู ุงูุฌููุฒูุฉ (ูุง ุนููู ุนูู ุงูุชุฑุฌูุฉ ุงููุธูุนุฉ ๐). ุจุงูุชุนุฑูู ุงูุฌููุฒูุฉ ูู ูุณุจุฉ ุงูููุช ุงูุฐู ูููู ููู ุงููุธุงู ูุนูู ุฅูู ุงูุฒูู ุงูููู ุงููุชููุน ููู ุฃู ูููู ุงููุธุงู ูุนูู. ูุซูุงู ูู ุฃุฎุฐูุง ูุซุงู ุจุฑูุงูุฌ ุทุจู ูุฑุงูุจ ูุจุถุงุช ุงูููุจ ููุฑูุถุ ูุฐุง ุงููุธุงู ูุทููุจ ููู ุฌููุฒูุฉ ุนุงููุฉ ุฌุฏุงู. ููุซูุงู ุฎูุงู ูู ุชู ุงูููุงุณ ุนูู ููู ูุงููุ ูู ุนูู ุงููุธุงู ุจุดูู ูุนุงู ุจุฏูู ุฃุฎุทุงู ุฎูุงู ูุฐุง ุงูููู ูููู ุฃู ุงูุฌุงูุฒูุฉ ูู ูกูููช.  3600 / 3600 = 1 ุจุงูุฏูุงุฆู. 
ูููู ูู ุญุงู ุฃู ุงููุธุงู ุญุฏุซ ููู ุฎุทุฃ ูููู ููุฏุฉ ุฎูุณ ุฏูุงุฆูุ ูุฃู ูุฐู ุงููุณุจุฉ ุณูู ุชููุต ูุชุตุจุญ 0.998% 
3595 / 3600 = 0.998. ุฑุจูุง ุชุจุฏู ูุฐู ุงููุณุจุฉ ุนุงููุฉุ ูููู ูู ุญุงูุฉ ุงูุฃุฌูุฒุฉ ุงูุทุจูุฉ ุฑุจูุง ุชุนุชุจุฑ ุฎุทูุฑุฉ ุฌุฏุงู ูุบูุฑ ููุจููุฉ.


--- 
# Supervisord

ูู ูุฐู ุงูุชุฏูููุฉุ ุณูู ููุงูุด ูุซุงู ุจุณูุทุ ุจุงูุชุฃููุฏ ูู ูุชุทุฑู ูุฃูุซูุฉ ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุงููุชุฑูููุ ุฃู ุฃู ุฃุฌูุฒุฉ ุทุจูุฉ (ุชุฃููู ุฌุงูุฒูุฉ ุนุงููุฉ ูููุฐุง ุฃูุธูุฉ ูุนุชุจุฑ ูุตุฉ ูุฎุชููุฉ ุชูุงูุงู). ูู ูุฐู ุงูุชุฏูููุฉุ ุณูู ูุทุฑุญ ุจุฑูุงูุฌ ุจุณูุทุ ูุซู Chat botุ ูุณูู ูููู ุจุงุณุชุนูุงู ุฃุฏุงุฉ ุชุฏุนู Supervisord ูุฃุฏุงุฑุฉ ุงููุนุงูุฌุฉ process ุงูุฎุงุต ุจุจุฑูุงูุฌูุง ุจุญูุซ ุชููู ุจูุฑุงูุจุชู ูุชุถูู ุฃู ูุฐุง ุงูุจุฑูุงูุฌ ูุนูู ุจุดูู ุฏุงุฆูุ ูุชููู ุจุฃุนุงุฏุฉ ุชุดุบููู ูู ุญุงู ุญุฏูุซ ุฃุฎุทุงู ูุชููู ุงูุจุฑูุงูุฌ ุนู ุงูุนูู. 

ุณูุจุฑูุงูุฒุฑุฏูุ ูู ุจุฑูุฌูุฉ ูุฌุงููุฉ ูููุชูุญุฉ ุงููุตุฏุฑุ ุชููู ุจูุฑุงูุจุฉ ูุฃุฏุงุฑุฉ ุงููุนุงูุฌุงุช Processesุ ุนูู ุฃูุธูุฉ Unix ููู ุงูุฌุฏูุฑ ุจุงูุฐูุฑ ุฃู ูุฐู ุงูุฃุฏุงุฉ ุชู ุจูุงุกูุง ุจุงุณุชุฎุฏุงู ูุบุฉ ุงูุจุงูุซูู. ุณูุจุฑูุงูุฒุฑุฏ ุชุนุชุจุฑ ูุซุงููุฉ ูู ุงูุณููุงุฑูููุงุช ุงูุชุงููุฉ:

1. ุชุดุบูู ุฎุฏูุฉ ุฃู ุจุฑูุงูุฌ ุจุดูู ุขูู ุนูุฏ ุชุดุบูู \ ุฃุนุงุฏุฉ ุฃููุงุน ุงูุฌูุงุฒ (ุงูุณูุฑูุฑ)
2. ุฃุนุงุฏุฉ ุชุดุบูู ุงูุฎุฏูุฉ \ ุงูุจุฑูุงูุฌ ุนูุฏ ุญุฏูุซ ุฎุทุฃ ูุง (ูููู ุถุจุท ุฃุนุงุฏุฉ ุงููุญุงูุฉ ุญุชู ุนุฏุฏ ูุนูู ูู ุงููุฑุงุช)

ุงูุณููุงุฑูููุงุช ุงูุณุงุจูุฉ ุชุนุชุจุฑ ุฃุณุงุณูุฉ ูุถูุงู ุฌุงูุฒูุฉ ุนุงููุฉ ูุฃู ุฎุฏูุฉ. 

ูู ุงูููุฑุงุช ุงููุงุฏูุฉ ุณูููู ุจุดุฑุญ ููููุฉ ุชูุตูุจ ุจุฑูุฌูุฉ Supervisordุ ุซู ุณูู ูุทุฑุญ ุจุฑูุงูุฌ ุจุณูุท ููุซุงู ููููู ุจุชููุฆุฉ ูุถุจุท Supervisord ููุนูู ุนูู ูุฑุงูุจุฉ ูุชุดุบูู ุจุฑูุงูุฌูุง.

--- 

# The Script

ูุชูุถูุญ ููุฑุฉ ุนูู Supervisord ุณูููู ุจุงุณุชุนูุงู ุจุฑูุงูุฌ ุจุณูุท ุฌุฏุงูุ ูู ุนุจุงุฑุฉ ุนู ุฎุงุฏู ููุจ ูููู ุจุฃุฑุฌุงุน ุฌููุฉ โHello Worldโ ุนูุฏูุง ูุชู ุฅุฑุณุงู ุทูุจ ูู. ุงูุจุฑูุงูุฌ ููุชูุจ ุจูุบุฉ ุงูุจุงูุซูู:


    # Note I got this gist from here: https://bit.ly/2KKUB1e
    import http.server
    import socketserver
    from http import HTTPStatus
    
    
    class Handler(http.server.SimpleHTTPRequestHandler):
        def do_GET(self):
            self.send_response(HTTPStatus.OK)
            self.end_headers()
            self.wfile.write(b'Hello world')
    
    
    httpd = socketserver.TCPServer(('', 8000), Handler)
    httpd.serve_forever()

ูุงุญุธ ุฃููุง ุงุณุชุนูููุง ููุง ููุชุจุฉ httpุ ููู ุฃุญุฏู ุงูููุชุจุงุช ุงูุฃุณุงุณูุฉ ูู ุงูุจุงูุซููุ ุจุบูุฉ ุชุจุณูุท ุงููุซุงู ุงูุซุฑ. ุงูุขู ูู ุจูุณุฎ ูุฐุง ุงูููุฏ ุฅูู ุฌูุงุฒู ุงููุญูู ุซู ูู ุจุชุฌุฑุจุฉ ุชุดุบููู ููุง ููู (ุนูู ูุฑุถ ุฃููุง ุฃุณูููุง ุงูููู app.py):

```
python3 app.py
```

ูู ุฎูุงู ุงููุชุตูุญุ ุฃู ุญุชู ูู ุฎูุงู ุณุทุฑ ุงูุฃูุงูุฑ ูู ููุช ุจุงุณุชุนูุงู cURLุ ูููููุง ุชุฌุฑุจุฉ ุฃุฑุณุงู ุทูุจ GET ููุณูุฑูุฑ ููุง ููู:

```
curl localhost:8000
Hello world
```
--- 
# ุชูุตูุจ Supervisord

ูุชูุตูุจ Supervisord ูููููุง ุงุณุชุนูุงู ูุฏูุฑ ุงูุญุฒู ูู ุฃุจููุชู ููุง ููู: 


    sudo apt-get install -y supervisor

ุจุนุฏ ุฐูู ูููููุง ูุนุงููุชู ุนูู ุฃุณุงุณ ุฎุฏูุฉ ูู ุงููุธุงู ูุชุดุบููู ููุง ููู: 


    sudo service supervisor start



# ุถุจุท ุงูุฃุนุฏุงุฏุงุช ูู Supervisord

ุนูููุง ุงูุขู ุฃุฎุจุงุฑ Supervisord ุนู ุงูุจุฑูุงูุฌ ุงูุฐู ูููุง ุจูุชุงุจุชู ููููู ุจุฅุฏุงุฑุชู ููุฑุงูุจุฉ ุนููู. ูู ุงูุฌุฏูุฑ ุจุงูุฐูุฑ ุฃู Supervisord ูููู ุจูุฑุงุกุฉ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุงูููุฌูุฏุฉ ูู ุงููุณุงุฑ `/etc/supervisor/conf.d/` ูุฐูู ูู ูุง ุนูููุง ูู ุฃูุดุงุก ููู ุฌุฏูุฏ ุฏุงุฎู ูุฐุง ุงููุณุงุฑ ููุชุงุจุฉ ุฅุนุฏุงุฏุงุช ุจุฑูุงูุฌูุง ููู. 


> ููุงุญุธุฉ ุณุฑูุนุฉ: ุนุฑููุง ูุณุงุฑ ุงูุฅุนุฏุงุฏุงุช ูู ุฎูุงู ููู ุงูุฃุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ ุงูููุฌูุฏ ูู `/etc/supervisor/supervisord.conf`   ุญูุซ ูู ูุชุญุชู ููุฌุฏุช ุฃูู ูุชู ุชุถููู ุฌููุน ุงููููุงุช ุงูููุฌูุฏุฉ ุถูู ูุณุงุฑ conf.d ููุง ููู: 
> 
    [include]
    files = /etc/supervisor/conf.d/*.conf

ูู ุจุฅูุดุงุก ููู ูุฅุนุฏุงุฏุงุช ุจุฑูุงูุฌูุง ููุง ููู: 


    sudo touch /etc/supervisor/conf.d/hello_world.conf

ูุจุนุฏูุง ูู ุจุงูุฏุฎู ุฅูู ูุฐุง ุงูููู ุจุงุณุชุฎุฏุงู ูุญุฑุฑ ุงููุตูุต ุงูููุถู ูุฏูู (nano, vim, โฆ) ุซู ุฃูุชุจ ุงูุฃุนุฏุงุฏุงุช ุงูุชุงููุฉ:


    [program:hello_world]
    command=python3 app.py 
    directory=/home/ubuntu/hello_world
    autostart=true
    autorestart=true
    startretries=3
    strerr_logfile=/home/ubuntu/hello_world/out.log
    stdout_logfile=/home/ubuntu/hello_world/out.log
    user=www-data

ุงูุขู ููุดุฑุญ ููููุงู ุงูุฃุนุฏุงุฏุงุช ุงูุชู ูููุง ุจูุชุงุจุชูุง:

- ุงูุณุทุฑ ุงูุฃูู ูููุง ุจุชุนุฑูู ุงุณู ุงูุจุฑูุงูุฌ ุงูุฐู ุณูููู supervisord ุจุฅุฏุงุฑุชูุ ูู ูุซุงููุง hello_world
- ูู ุงูุณุทุฑ ุงูุซุงููุ ุงูุฃูุฑ ุงูุฐู ุณูุชู ุชูููุฐู ูุชุดุบูู ุงูุจุฑูุงูุฌ
- ุงูุณุทุฑ ุงูุซุงูุซุ ุงููุณุงุฑ ุงูุฐู ุณูููู supervisord ุจุชุดุบูู ุงูุฃูุฑ ููู
- ุงูุณุทุฑ ุงูุฑุงุจุนุ autostart=true ููู ูุชู ุชุดุบูู ุงูุจุฑูุงูุฌ ุนูุฏ ุชุดุบูู ุงูุณูุฑูุฑ
- ุงูุณุทุฑ ุงูุฎุงูุณ ููู ุฌุฏุงูุ ููุง autorestart=trueุ ูุนูุงูุง ุฃู ุงูุจุฑูุงูุฌ ุณูุชู ุฅุนุงุฏุฉ ุชุดุบููู ุจุดูู ุชููุงุฆู ูู ุญุงู ุญุฏูุซ ุฎูู ูุง ุฃุซูุงุก ุนููู
- ุงูุณุทุฑ ุงูุณุงุฏุณุ startretries=3ุ ููุถุญ ุนุฏุฏ ุงููุฑุงุช ุงูุชู ุณูุชู ูุญุงููุฉ ุชุดุบูู ุงูุจุฑูุงูุฌ ูุจู ุฃู ูุชู ุงุนุชุจุงุฑ ุฃู ุญุงูุฉ ุงูุชุดุบูู ูุงุดูุฉ
- ุงูุณุทุฑ ุงูุณุงุจุน ูุงูุซุงููุ ููุง ุชู ุถุจุท ุงูููู ุงูุฐู ุณูุชู ูุชุงุจุฉ ุฎุฑุฌ ุงูุจุฑูุงูุฌ ุนููู
- ุงูุณุทุฑ ุงูุชุงุณุนุ ููุถุญ ุงููุณุชุฎุฏู ุงูุฐู ุณูููู ุจุชุดุบูู ูุฐุง ุงูุจุฑูุงูุฌ


# ุชุญุฏูุซ ุงูุฃุนุฏุงุฏุงุช ูู Supervisord

ูู ุงูููุฑุฉ ุงูุณุงุจูุฉ ูููุง ุจูุชุงุจุฉ ููู ุงูุฃุนุฏุงุฏุงุช ุงูุฐู ูู ุฎูุงูู ูููู ูู supervisord ุฃู ูุชุนุฑู ููููู ุจุชุดุบูู ุงูุจุฑูุงูุฌ ุงูุฐู ูููุง ุจูุชุงุจุชูุ ูููู ูุจู ุฐูู ุนูููุง ุฃู ูููู ุจุชุญุฏูุซ ุงูุฃุนุฏุงุฏุงุช ููุฎุจุฑ Supervisord ุฃููุง ูููุง ุจุนูู ุชุบููุฑ ูู ุงูุฃุนุฏุงุฏุงุช. ูููู ุฐูู ูู ุฎูุงู ุชูููุฐ ุฃูุฑ `reread` ูุจุนุฏู ุฃูุฑ `update` ููุง ููู:


    sudo supervisorctl reread
    sudo supervisorctl update

ุงูุขู ุจุฑูุงูุฌูุง ูุฌุจ ุฃู ูููู ูุนููุ ูููููุง ุณุคุงู supervisord ุฃู ูููู ุจุนุฑุถ ุงูุจุฑุงูุฌ ุงูุชู ูููู ุจุฅุฏุงุฑุชูุง ูู ุฎูุงู: 


    sudo supervisorctrl status

ูุณูู ุชุธูุฑ ููุง ุงููุชูุฌุฉ: 


    hello_world                      RUNNING   pid 180772, uptime 0:01:31

ููู ุฃุฑุฏูุง ุฃูุถุงู ุฃู ูููู ุจุฅุฑุณุงู ุทูุจ ููุณูุฑูุฑ ูู ุงููุชุตูุญ ุฃู ูู ุฎูุงู ุณุทุฑ ุงูุฃูุงูุฑ ููุง ูุนููุง ุณุงุจูุงู: 

    curl localhost:8000
    Hello world

ููุงุญุธ ุฃู ุงูุจุฑูุงูุฌ ูุนูู ููุง ูู ูุชููุน. 

ุงูุขู ุจุงูุฅุถุงูุฉ ุฅูู ุชุนูููุฉ `status` ุงูุชู ุฑุฃููุงูุง ูููููุง ุฃูุถุงู ุฃุฑุณุงู ุนุฏุฉ ุฃูุงูุฑ ู supervisordุ ูููููุง ูุนุฑูุฉ ุงูุฃูุงูุฑ ุงููุชุงุญุฉ ูู ุฎูุงู help ููุง ููู:

    sudo supervisorctl help
    
    default commands (type help <topic>):
    =====================================
    add    exit      open  reload  restart   start   tail   
    avail  fg        pid   remove  shutdown  status  update 
    clear  maintail  quit  reread  signal    stop    version

ููุซูุงู ูููููุง ุฃููุงู ุงูุจุฑูุงูุฌ ูู ุฎูุงู ุชุนูููุฉ `stop` ุฃู ุฃุนุงุฏุฉ ุชุดุบูููุง `restart` ุฃู ุชุดุบูู ุงูุฎุฏูุฉ ูู ุญุงู ูู ุชูู ุชุนูู `start`. ููููู ุงุณุชูุดุงู ุฌููุน ูุฐู ุงูุชุนูููุงุช ุงููููุฏุฉ ูู ุฃุญุจุจุช ุนุฒูุฒู ุงููุงุฑุฆ. 

ุงูุขู ูุฃู ุจุฑูุงูุฌูุง ูุนูู ูู ุงูุฎูููุฉ ุนูู ุดูู ุฎุฏูุฉุ ุชุนูู ุจุดูู ุชููุงุฆู ุนูุฏ ุฅููุงุน ุงูุฌูุงุฒุ ูุชุนูุฏ ุชุดุบูู ููุณูุง ูู ุญุงู ุญุฏูุซ ุฎูู ูุง ุฃุซูุงุก ุงูุชุดุบูู. 


![ูุญูู ุงูุฐูุงุก](https://paper-attachments.dropbox.com/s_F82AF820B646632230135620136434F83C872EE7E557CDE6832B7D6CE7A9015D_1609311922315_image.png)

--- 

# ุงูุฎุงุชูุฉ

ูู ูุฐู ุงูุชุฏูููุฉุ ูููุง ุจุงูุชุนุฑู ุนูู ููููู ุงูุฌุงูุฒูุฉ Availabilityุ ููุง ุชุนุฑููุง ุนูู ุจุฑูุฌูุฉ Supervisordุ ูุงูุชู ุชููู ุจูุฑุงูุจุฉ ูุฅุฏุงุฑุฉ ุงููุนุงูุฌุงุช ูุชุญููู ุฌุงูุฒูุฉ ุนุงููุฉ. ูููุง ุจุจูุงุก ูุซุงู ุจุณูุท ุนู ููุจ ุณูุฑูุฑ ูููู ุจุทุจุงุนุฉ ุฌููุฉ `hello world` ุนูุฏ ุฅุฑุณุงู ุทูุจ ูู. ููููุง ุจุถุจุท Supervisord ููููู ุจุชุดุบูู ูุฐุง ุงูุณูุฑูุฑ ุจุดูู ุชููุงุฆู. 

ุฃุชููู ุฃู ุชููู ูุฐู ุงูุชุฏูููุฉ ูููุฏุฉ ููุฌููุน. 



# ุจุนุถ ุงููุฑุงุฌุน ุงููููุฏุฉ 

- Supervisord
- https://serversforhackers.com/c/monitoring-processes-with-supervisord
-  https://learning.oreilly.com/library/view/software-architecture-in/9780132942799/ch05.html
-  https://www.opensourceforu.com/2019/10/how-to-run-multiple-services-inside-a-single-container-using-supervisord/
